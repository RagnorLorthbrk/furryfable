import axios from "axios";

const {
  SHOPIFY_STORE_DOMAIN,
  SHOPIFY_ACCESS_TOKEN,
  SHOPIFY_API_VERSION
} = process.env;

const api = axios.create({
  baseURL: `https://${SHOPIFY_STORE_DOMAIN}/admin/api/${SHOPIFY_API_VERSION}`,
  headers: {
    "X-Shopify-Access-Token": SHOPIFY_ACCESS_TOKEN,
    "Content-Type": "application/json"
  }
});

// ---------- FIND ARTICLE BY HANDLE ----------
async function getArticleByHandle(handle) {
  const blogsRes = await api.get("/blogs.json?limit=250");
  const blogs = blogsRes.data.blogs;

  for (const blog of blogs) {
    const articlesRes = await api.get(
      `/blogs/${blog.id}/articles.json?limit=250`
    );

    const article = articlesRes.data.articles.find(
      a => a.handle === handle
    );

    if (article) return article;
  }

  return null;
}

// ---------- MAIN EXPORT ----------
export async function updateShopifyMetadata(handle, metadata) {
  const article = await getArticleByHandle(handle);

  if (!article) {
    throw new Error(`Shopify article not found for handle: ${handle}`);
  }

  // 1️⃣ Update excerpt + tags
  await api.put(`/articles/${article.id}.json`, {
    article: {
      id: article.id,
      summary_html: metadata.excerpt,
      tags: metadata.tags.join(", ")
    }
  });

  // 2️⃣ Update meta description
  await api.post(`/articles/${article.id}/metafields.json`, {
    metafield: {
      namespace: "global",
      key: "description_tag",
      value: metadata.metaDescription,
      type: "single_line_text_field"
    }
  });

  console.log(`Updated Shopify metadata for: ${handle}`);
}
